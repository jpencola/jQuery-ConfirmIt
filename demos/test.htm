<html>
<head>
<title>Leave Page On Incomplete Form Test</title>
</head>

		<script src="http://code.jquery.com/jquery-1.6.min.js" type="text/javascript"></script>
		<!--
		<script src="../src/jquery.confirm.it.js" type="text/javascript"></script>
-->
<script  type="text/javascript">

$(document).ready(function(){

	console.log("v 1.3");
	
	
	
	var activeForm;
	
	function initLeavePageWarning(formSelector)
	{
		var me = this;
		me.window = window;
		
		var form = $(formSelector);
		
		var formKids = form.find("select,textarea,:text");
		var checkKids = form.find(":checkbox,:radio");		
		var formSubmits = form.find("input[type=submit],button");
		
		formKids.each(function (i) {
				console.log($(this).attr("name") + " original = "+$(this).val());
			  $(this).data('initial_value', $(this).val());
		});
		checkKids.each(function (i) {
			var val = $(this).is(":checked") ? "t": "f";
			console.log($(this).attr("name") + " original = "+val);
			  $(this).data('initial_value', val);
		});
		formSubmits.click(function () {
			activeForm = me;
			formSubmitted = true;
			console.log("form button clicked");
			window.onbeforeunload = nothing;	
		});
		
		function LeaveWarning(e) {	
			var ThisIsActive = !!(activeForm == me);
			console.log("LeaveWarning activeForm = "+activeForm +", me = "+me+", ThisIsActive = "+ThisIsActive);
			
			//if(!ThisIsActive)
			//	return false;
			
			var formHasChanged = false;
			
			formKids.each(function (i) {
				var oldVal = $(this).data('initial_value') + "";
				var newVal = $(this).val() + "";
				
				if (oldVal != newVal)
				{
					console.log("formKids "+$(this).attr("name") +" "+ oldVal+ " != "+newVal);
					formHasChanged = true;
					return false; //break
				}
			});
			
			if(!formHasChanged)
			{
				checkKids.each(function (i) {
					var oldVal = $(this).data('initial_value') + "";
					var newVal = ($(this).is(":checked") ? "t": "f")+ "";
					if (oldVal != newVal)
					{
						console.log("checkKids "+$(this).attr("name") +" "+ oldVal+ " != "+newVal);
						formHasChanged = true;
						return false; //break
					}
				});
			}
			
			console.log("formHasChanged= "+formHasChanged);
			console.log("formSubmitted= "+formSubmitted);
			if(formSubmitted || !formHasChanged)
			{
				console.log("this is where we would unload");
				window.onbeforeunload = nothing;
				$(window).unload();
				return true;
			}
		  var message = "It looks like you have unfinished business. Leave this page?",
		  e = e || window.event;
		  // For IE and Firefox
		  if (e) {
			e.returnValue = message;
		  }

		  // For Safari
		  return message;
	};
	
		
		var formSubmitted = false;
		me.window.onbeforeunload = LeaveWarning;
	}
	
	
	
	//initLeavePageWarning("#myForm2");
	
	//initLeavePageWarning("#myForm");
	
	initLeavePageWarning("body");
	
	//now we need  a way to remove one without affecting the other.

	
});

</script>



<body>

<a href="http://www.google.com" >an external link</a>

<br/>
<br/>

<form id="myForm" action="test.htm" method="post">
<fieldset>
<legend>sample form with leave page warning</legend>

<div style="float:left">
text input <br/>
<input type="text" value="Steve" name="firstname" />


<br /><br />
big long email<br/>
<textarea name="myTextArea"></textarea>
<br /><br />

single select 
<br/>
<select name="singleselect">
  <option value="1">SimpleConfirm</option>
  <option value="2" selected>QuickConfirm</option>
  <option value="3">CoolConfirm</option>
  <option value="4">ConfirmIt</option>
  <option value="5">ConfirmThis</option>
</select>

</div>

<div style="float:left;margin-left:10px;">


multi select 
<br/>
<select multiple name="multiselect">
  <option value="1">SimpleConfirm</option>
  <option value="2">QuickConfirm</option>
  <option value="3" selected>CoolConfirm</option>
  <option value="4" selected>ConfirmIt</option>
  <option value="5">ConfirmThis</option>
</select>
<br /><br />


not checked by default:
<br/>
<input type="checkbox" name="uncheckedbox" value="true" />
<br/>
checked by default:
<br/>
<input type="checkbox" name="checkedbox" value="true" checked="checked" />

<br /><br />
radio <br />
<input type="radio" name="gender" value="male" checked="checked" /> Male<br />
<input type="radio" name="gender" value="female" /> Female

</div>

<br style="clear:both" /><br />
<input type="submit" value="submit form" />


<br />
</fieldset>
</form>

<form id="myForm2" action="test.htm" method="post">
<fieldset>
<legend>a second form </legend>

<input type="text" value="Perrie" name="lastname" />
<input type="submit" value="submit form" />

<br />
</fieldset>
</form>

</body>